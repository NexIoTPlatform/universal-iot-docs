---
title: 01.HTTP接口规范
date: 2025-03-05 21:25:02
permalink: /iot/http/api-specification
categories:
  - 设备接入
tags:
  - 设备接入
---

# Universal IoT Platform HTTP API 文档

## 概述

Universal IoT Platform 提供了一套完整的HTTP REST API，用于物联网设备的管理和数据交互。本文档详细描述了所有可用的API端点、请求格式、响应格式以及认证方式。

## 基础信息

- **基础URL**: `http://{host}:{port}`
- **API版本**: v1
- **内容类型**: `application/json`
- **字符编码**: UTF-8

## 认证方式

### OAuth2 认证

平台支持两种OAuth2认证方式：

#### 1. 客户端认证 (Client Credentials)

适用于服务间调用，使用客户端ID和密钥进行认证。

**获取访问令牌**

```http
POST /oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials&client_id={client_id}&client_secret={client_secret}
```

**请求参数**:

- `grant_type`: 固定值 `client_credentials`
- `client_id`: 客户端ID
- `client_secret`: 客户端密钥

**响应示例**:

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 7200,
  "scope": "all"
}
```

#### 2. 密码认证 (Password)

适用于用户登录场景，使用用户名和密码进行认证。

**获取访问令牌**

```http
POST /oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&username={username}&password={password}&client_id=web&client_secret=web&scope=all
```

**请求参数**:

- `grant_type`: 固定值 `password`
- `username`: 用户名
- `password`: 密码
- `client_id`: 固定值 `web`
- `client_secret`: 固定值 `web`
- `scope`: 固定值 `all`

**响应示例**:

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 7200,
  "refresh_token": "refresh_token_value",
  "scope": "all"
}
```

### 使用访问令牌

获取到访问令牌后，在后续的API请求中需要在请求头中包含：

```
Authorization: Bearer {access_token}
```

对于客户端认证模式，还可以添加用户ID头：

```
User-Id: {user_id}
```

## API 端点

### 设备管理

#### 1. 设备注册

**接口地址**: `POST /api/openapi/v1/iot/device/{productKey}/add`

**请求头**:

```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**请求体**:

```json
{
  "cmd": "dev_add",
  "deviceId": "device_001",
  "deviceKey": "optional_device_key",
  "data": {
    "deviceName": "智能传感器",
    "latitude": "31.207561",
    "longitude": "120.23475",
    "code": "optional_verification_code",
    "model": "optional_device_model",
    "entity": "123456"
  }
}
```

**请求参数说明**:

- `cmd`: 固定值 `dev_add`
- `deviceId`: 设备唯一标识符（必填）
- `deviceKey`: 设备密钥（可选）
- `data.deviceName`: 设备名称（必填）
- `data.latitude`: 设备纬度（必填）
- `data.longitude`: 设备经度（必填）
- `data.code`: 摄像头类设备验证码（可选）
- `data.model`: 设备型号（可选）
- `data.entity`: 自定义数据（可选）

**响应示例**:

```json
{
  "code": 0,
  "message": "success",
  "result": "device_registration_result"
}
```

#### 2. 设备查询

**接口地址**: `GET /api/openapi/v1/iot/device/info/{productKey}/{deviceId}`

**请求头**:

```
Authorization: Bearer {access_token}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "success",
  "result": {
    "deviceId": "device_001",
    "deviceName": "智能传感器",
    "latitude": "31.207561",
    "longitude": "120.23475",
    "status": "online",
    "createTime": "2024-01-01T10:00:00Z"
  }
}
```

#### 3. 设备更新

**接口地址**: `PUT /api/openapi/v1/iot/device/{productKey}/{deviceId}`

**请求头**:

```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**请求体**:

```json
{
  "deviceName": "更新后的设备名称",
  "latitude": "31.207562",
  "longitude": "120.23476",
  "detail": "设备备注信息"
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "success",
  "result": "update_success"
}
```

#### 4. 设备删除

**接口地址**: `DELETE /api/openapi/v1/iot/device/{productKey}/{deviceId}`

**请求头**:

```
Authorization: Bearer {access_token}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "success",
  "result": "delete_success"
}
```

### 设备状态管理

#### 1. 设备上线

**接口地址**: `PUT /api/openapi/v1/iot/online/{productKey}/{deviceId}`

**请求头**:

```
Authorization: Bearer {access_token}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "success",
  "result": "device_online_success"
}
```

#### 2. 设备下线

**接口地址**: `PUT /api/openapi/v1/iot/offline/{productKey}/{deviceId}`

**请求头**:

```
Authorization: Bearer {access_token}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "success",
  "result": "device_offline_success"
}
```

### 数据上报

#### 1. 属性上报

**接口地址**: `POST /api/openapi/v1/iot/device/report/properties/{productKey}/{deviceId}`

**请求头**:

```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**请求体**:

```json
{
  "properties": {
    "temperature": 25.5,
    "humidity": 60.0,
    "switchStatus": 1,
    "batteryLevel": 85
  }
}
```

**请求参数说明**:

- `properties`: 属性数据对象，键值对形式

**响应示例**:

```json
{
  "code": 0,
  "message": "success",
  "result": "properties_reported_success"
}
```

#### 2. 事件上报

**接口地址**: `POST /api/openapi/v1/iot/device/report/event/{productKey}/{deviceId}`

**请求头**:

```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**请求体**:

```json
{
  "event": "temperatureAlarm",
  "messageType": "EVENT",
  "data": {
    "alarmLevel": "high",
    "alarmMessage": "温度过高",
    "currentTemperature": 35.5,
    "threshold": 30.0
  }
}
```

**请求参数说明**:

- `event`: 事件标识符（必填）
- `messageType`: 固定值 `EVENT`
- `data`: 事件数据对象（可选）

**响应示例**:

```json
{
  "code": 0,
  "message": "success",
  "result": "event_reported_success"
}
```

## 错误处理

### 错误响应格式

所有API在发生错误时都会返回统一的错误响应格式：

```json
{
  "code": 1001,
  "message": "error_message",
  "result": null
}
```

### 常见错误码

| 错误码 | 说明           | 解决方案                           |
| ------ | -------------- | ---------------------------------- |
| 0      | 成功           | -                                  |
| 1001   | 参数错误       | 检查请求参数是否完整和正确         |
| 1002   | 认证失败       | 检查访问令牌是否有效               |
| 1003   | 权限不足       | 检查用户权限                       |
| 1004   | 设备不存在     | 检查设备ID是否正确                 |
| 1005   | 设备已存在     | 使用不同的设备ID或设置忽略重复标志 |
| 2001   | 服务器内部错误 | 联系技术支持                       |
| 2002   | 服务不可用     | 稍后重试                           |

### HTTP状态码

- `200 OK`: 请求成功
- `400 Bad Request`: 请求参数错误
- `401 Unauthorized`: 认证失败
- `403 Forbidden`: 权限不足
- `404 Not Found`: 资源不存在
- `500 Internal Server Error`: 服务器内部错误

## 请求示例

### cURL 示例

#### 1. 获取访问令牌

```bash
# 客户端认证
curl -X POST "http://your-host:port/oauth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials&client_id=your_client_id&client_secret=your_client_secret"

# 密码认证
curl -X POST "http://your-host:port/oauth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password&username=your_username&password=your_password&client_id=web&client_secret=web&scope=all"
```

#### 2. 设备注册

```bash
curl -X POST "http://your-host:port/api/openapi/v1/iot/device/your_product_key/add" \
  -H "Authorization: Bearer your_access_token" \
  -H "Content-Type: application/json" \
  -d '{
    "cmd": "dev_add",
    "deviceId": "device_001",
    "data": {
      "deviceName": "智能传感器",
      "latitude": "31.207561",
      "longitude": "120.23475"
    }
  }'
```

#### 3. 设备上线

```bash
curl -X PUT "http://your-host:port/api/openapi/v1/iot/online/your_product_key/device_001" \
  -H "Authorization: Bearer your_access_token"
```

#### 4. 属性上报

```bash
curl -X POST "http://your-host:port/api/openapi/v1/iot/device/report/properties/your_product_key/device_001" \
  -H "Authorization: Bearer your_access_token" \
  -H "Content-Type: application/json" \
  -d '{
    "properties": {
      "temperature": 25.5,
      "humidity": 60.0
    }
  }'
```

#### 5. 事件上报

```bash
curl -X POST "http://your-host:port/api/openapi/v1/iot/device/report/event/your_product_key/device_001" \
  -H "Authorization: Bearer your_access_token" \
  -H "Content-Type: application/json" \
  -d '{
    "event": "temperatureAlarm",
    "messageType": "EVENT",
    "data": {
      "alarmLevel": "high",
      "alarmMessage": "温度过高"
    }
  }'
```

## 最佳实践

### 1. 令牌管理

- 访问令牌有效期为2小时，建议在令牌过期前自动刷新
- 客户端认证模式不支持刷新令牌，需要重新获取
- 密码认证模式支持刷新令牌，可以使用refresh_token刷新访问令牌

### 2. 错误处理

- 始终检查响应的 `code` 字段
- 实现重试机制处理临时网络错误
- 记录详细的错误日志便于问题排查

### 3. 请求频率

- 避免过于频繁的API调用
- 对于数据上报，建议批量上报减少请求次数
- 遵循平台的速率限制

### 4. 安全性

- 妥善保管客户端密钥和用户密码
- 使用HTTPS协议进行安全传输
- 定期轮换访问令牌

## 配置说明

### 配置文件

在 `src/main/resources/config/uiot.properties` 中配置：

```properties
# 服务地址
universal.iot.host=your-host:port

# 客户端认证参数
universal.iot.clientId=your_client_id
universal.iot.clientSecret=your_client_secret

# 密码认证参数（可选）
universal.iot.username=your_username
universal.iot.password=your_password

# 认证类型：password 或 client_credentials
universal.iot.grantType=client_credentials

# 客户端用户ID（可选）
universal.iot.config.client.userId=1

# 是否启用客户端用户ID（可选）
universal.iot.config.client.enable=true
```

### 环境变量

也可以通过环境变量配置：

```bash
export universal.iot.host=your-host:port
export universal.iot.clientId=your_client_id
export universal.iot.clientSecret=your_client_secret
export universal.iot.grantType=client_credentials
```

## 更新日志

### v1.0.0

- 初始版本发布
- 支持设备生命周期管理
- 支持属性上报和事件上报
- 支持OAuth2认证

---

_本文档基于 Universal IoT Platform v1.0.0 编写，如有更新请参考最新版本文档。_
